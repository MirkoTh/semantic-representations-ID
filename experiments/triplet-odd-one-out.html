<!DOCTYPE html>
<html>

<head>
    <title>Object Comparison Task</title>
    <script src="jspsych-dist/dist/jspsych.js"></script>
    <script src="jspsych-dist/dist/plugin-html-button-response.js"></script>
    <script src="jspsych-dist/dist/plugin-html-keyboard-response.js"></script>
    <script src="jspsych-dist/dist/plugin-preload.js"></script>
    <script src="jspsych-dist/dist/plugin-survey-text.js"></script>
    <script src="jspsych-dist/dist/plugin-survey-multi-choice.js"></script>
    <script src="jspsych-dist/dist/plugin-fullscreen.js"></script>

    <script src="expt-utils/jquery.min.js"></script>
    <script src="expt-utils/js-helpers.js"></script>
    <script src="expt-utils/jspsych-psychophysics.js"></script>
    <script src="expt-utils/practiceImageList.js"></script>
    <script src="expt-utils/properImageList.js"></script>
    
    

    <script src="https://pixijs.download/release/pixi.js"></script>

    <link rel="stylesheet" href="/jspsych-dist/dist/jspsych.css">

    </link>
</head>


<body></body>
<script>


    // still to do
    // save data on server
    // create fixed stimulus set and load it


    // This file demonstrates how to present multiple images in random order in succession.
    // That is, Rapid serial visual presentation (RSVP) 

    const jsPsych = initJsPsych({
        show_progress_bar: true,
        auto_update_progress_bar: false,
        on_finish: function () {
            jsPsych.data.displayData();
        }
    })

    const pixi_flag = jsPsych.data.getURLVariable('pixi_flag') === '1' ? true : false;


    // todos
    // instructions
        // select the image with a mouse click, which is least similar to the other two images
        // answer the questions honestly. if you are unsure about your response, just select first option coming to mind
    // instruction comprehension check
        // how many images are going to be displayed?
        // what is your task when the three objects are displayed on screen?
        // how do you select the image you find the most different from the others?
        // how do you respond the questions?
        // how do you redirect to prolific to confirm the successful completion of the study?
    // ask for demogrphic information
    // set up specific questionnaires
    // implement triplet odd-one-out task


    session_id = getQueryVariable('session');
    if (!session_id) { session_id = 1 }

    
    var n_comprehension_attempts = 1;

    var t_start = Date.now();
    // If this test is being run online (e.g., on MTurk), true will cause the file to be downloaded to the participant's computer.
    // If this test is on a server, and you wish to save the data file to that server, change this to false.
    // If changed to false, ensure that the php file (its in the directory!) and the empty "data" folder has also been appropriately uploaded to the server.
    // Incase of problems, feel free to contact me :)

    //----------------------------------------------------------------------



    if (window.location.search.indexOf('PROLIFIC_PID') > -1) {
        var participant_id = getQueryVariable('PROLIFIC_PID');
    }
    // If no ID is present, generate one using random numbers - this is useful for testing
    else {
        var participant_id = Math.floor(Math.random() * 1000);
    }
    // STUDY ID
    if (window.location.search.indexOf('STUDY_ID') > -1) {
        var studyID = getQueryVariable('STUDY_ID');
    }


    var possibleNumbers = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]


    var n_trials_proper = 5 // number of trials2 // 440//
    var n_trials_practice = 5 // 1 //1//

    var totalTrials = n_trials_practice + n_trials_proper; //total number of trials in the entire task (practice + main task)

    var n = 0 //keeps track of number of trials gone by
    var is_practice = 1;


    var triplet_set_practice = practiceImageList;
    var triplet_set_proper = properImageList;

    var data_cumulative;
    data_cumulative = [];

    var instructionsGo = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;"><br>Click on "Next" to start.<br><br></div>',
        choices: ["Next"]
    };

    var instructions1 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;"><b>INSTRUCTIONS</b><br><br><br>This is the similarity rating task.<br><br><br><br>This task is going to be in full-screen mode.<br><br><b> Please do not leave the full-screen mode. <br><br>Otherwise, the presented images may be illegible.<br><br></div>',
        choices: ["Next"]
    };
    var instructions2 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;">In every trial, three images are presented on the screen from left to right.<br><br>Click with the mouse on the image, which is least similar to the other two.<br><br></div>',
        choices: ["Next"]
    };
    var instructions3 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;">Please base your judgment on the objects, and nothing else than the objects.<br><br>If you do not recognize an object, base your judgment on your best guess as to what the object could be.</div>',
        choices: ["Next"]
    };
    var instructions4 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;">You get two practice trials to get used to the task.<br><br></div>',
        choices: ["Start Practice"]
    };
    var instructions_proper = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;">These were the two practice trials.<br><br>The main part of the similarity rating task is going to start now.</div>',
        choices: ["Start Main Part"]
    };

    const iti = 500; // ms

    var triplet_images_practice = practiceImageList;
    var triplet_images_proper = properImageList;


    var trial_template_practice = {

        type: jsPsychHtmlButtonResponse,
        stimulus: "",
        choices: ["", "", ""],
        button_html: function() {
            let imgs = jsPsych.timelineVariable('images_practice');
            return imgs.map(img => 
            `<button class='jspsych-btn' style='background:none; border:none; padding:0;'>
                <img src='${img}' width='150' height='150'>
            </button>`
            );
        },
        prompt: "<p>Select the image the least similar to the other two.</p>"
    };

    
    var trial_template_proper = {

        type: jsPsychHtmlButtonResponse,
        stimulus: "",
        choices: ["", "", ""],
        button_html: function() {
            let imgs = jsPsych.timelineVariable('images_proper');
            return imgs.map(img => 
            `<button class='jspsych-btn' style='background:none; border:none; padding:0;'>
                <img src='${img}' width='150' height='150'>
            </button>`
            );
        },
        prompt: "<p>Select the image the least similar to the other two.</p>"
    };


    //compcheck1: if answer incorrect, compcheck1 will be repeated until correct response inserted
    var comp_check_ooo_loop = {
        timeline: [comprehension_question_wmu_allinone, comp_feedback_wmu_verbose],
        loop_function: function (data) {
            len_data = data.values().length;

            if (
                data.values()[len_data - 2].correct == true
            ) {
                is_practice = 0;
                data_comprehension = {
                    participant_id: participant_id,
                    n_attempts: n_comprehension_attempts,
                    t_comprehension: Date.now() - t_start
                };
                let dataSaved = false;
                saveData(JSON.stringify(data_comprehension), "ooo_comprehension_check_" + session_id + "_" + participant_id + ".json", "ooo");
                checkDataSaving();

                return false;
            } else {
                n_comprehension_attempts += 1;
                n = 0 // keeps track of number of trials gone by
                return true;
            }
        }
    };

    const fullscreen_on = {
        type: jsPsychFullscreen,
        fullscreen_mode: true
    };

    var timeline = [];

    timeline.push(instructions0, instructions1, fullscreen_on, instructions2, instructions3, instructions4);
    
    // practice trials ooo
    timeline.push({
        timeline: [trial_template_practice],
        timeline_variables: triplet_images_practice,
        randomize_order: false
    });

    // start with proper trials
    timeline.push(instructions_proper)

    // comprehension check ooo
    timeline.push(comp_check_ooo_loop);

    // proper trials
    timeline.push({
        timeline: [trial_template_proper],
        timeline_variables: triplet_images_proper,
        randomize_order: false
    });


    var instructions_go_on = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<div style="font-size:30px;"><br>Well done!<br>You have now finished the similarity rating task. Rest for a minute to take a deep breath and prepare for the questionnaires.<br>Click on "Next" to continue with the questionnaires.<br></div>',
        choices: ["Next"],
        on_finish: function () {
            window.location.href = progress_url + "&session=" + session_id;
        }
    };
    timeline.push(instructions_go_on);

    jsPsych.run(timeline);


</script>

</html>